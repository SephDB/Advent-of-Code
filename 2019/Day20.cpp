#include <array>
#include <iostream>
#include <vector>
#include <bitset>
#include <complex>
#include <queue>
#include <string_view>
#include <unordered_map>
#include <map>
#include <algorithm>
#include <optional>
#include <chrono>

template<typename F>
double time(F&& f, int num_tries=1) {
    auto start = std::chrono::high_resolution_clock::now();
    for(int i = 0; i < num_tries; ++i) {
        f();
    }
    auto end = std::chrono::high_resolution_clock::now();
    std::chrono::duration<double> diff = end-start;
    return diff.count()/num_tries;
}

std::vector<std::string_view> split(std::string_view in, char delim) {
    std::vector<std::string_view> ret;
    std::size_t pos = 0;
    while((pos = in.find(delim)) != std::string_view::npos) {
        ret.push_back(in.substr(0,pos));
        in.remove_prefix(pos+1);
    }
    ret.push_back(in);
    return ret;
}

struct Coord {
    int x = -1;
    int y = -1;
    int level = 0;
    Coord operator+(Coord o) const {return {x+o.x,y+o.y,level};}
    Coord& operator+=(Coord o) {*this = *this + o; return *this;}
    Coord operator-(Coord o) const {return {x-o.x,y-o.y,level};}
    Coord& operator-=(Coord o) {*this = *this - o; return *this;}
    Coord operator-() const {return {-x,-y,level};}
    Coord operator*(Coord o) const {auto res = std::complex<int>{x,y}*std::complex<int>{o.x,o.y}; return {res.real(),res.imag(),level};}
    Coord& operator*=(Coord o) {*this = *this * o; return *this;}
    bool operator==(Coord o) const {return x==o.x and y==o.y and level == o.level;}
    bool operator!=(Coord o) const {return not (*this == o);}
    bool operator<(Coord o) const {return std::tie(level,x,y) < std::tie(o.level,o.x,o.y);}
};

constexpr std::array<Coord,4> directions{{{1,0},{-1,0},{0,1},{0,-1}}};

int opposite_coord(int current) {
    return current + 1 - 2*(current%2);
}

struct Tile {
    std::bitset<4> open_directions;
    template<typename F>
    void for_all_dirs(F&& f) const {
        for(int i = 0; i < 4; ++i) {
            if(open_directions.test(i)) f(i,directions[i]);
        }
    }
};

struct Maze {
    Maze(std::string_view input) {
        auto lines = split(input,'\n');

        //Discard outermost layer
        height = lines.size()-2;
        width = lines[0].size()-2;
        auto offset = Coord{1,1};

        std::map<int,std::pair<Coord,Coord>> found_portals;

        auto lookup = [&lines](Coord c) {return lines[c.y][c.x];};
        for(auto y = 1; y < lines.size()-1; ++y) {
            for(auto x = 1; x < lines[0].size()-1; ++x) {
                Coord current = {x,y};
                auto tile = lookup(current);
                std::bitset<4> open_directions;
                if(tile >= 'A' and tile <= 'Z') {
                    //Portal
                    auto dir_to_tile = std::find_if(directions.begin(),directions.end(),[&](Coord dir){return lookup(current+dir)=='.';});
                    if(dir_to_tile != directions.end()) {
                        auto tile_loc = current + *dir_to_tile;
                        char other = lookup(current - *dir_to_tile);
                        if(*dir_to_tile < Coord{0,0}) {
                            std::swap(tile,other);
                        }
                        int name = (other-'A')*26+tile-'A';
                        auto match = found_portals.find(name);
                        if(tile == 'A' and other == 'A') {
                            start = tile_loc-offset;
                        } else if(tile == 'Z' and other == 'Z') {
                            end = tile_loc-offset;
                        } else if(match == found_portals.end()) {
                            found_portals[name] = {current,tile_loc};
                        } else {
                            auto [portal,t] = match->second;
                            portals[current-offset] = t-offset;
                            portals[portal-offset] = tile_loc-offset;
                        }
                    }
                } else if(tile == '.') {
                    for(int i=0; i < 4; ++i) {
                        open_directions[i] = lookup(current+directions[i]) != '#';
                    }
                }
                tiles.push_back({open_directions});
            }
        }
        remove_dead_ends();
    }

    Coord actual(Coord c) const {
        auto p = portals.find({c.x,c.y}); //Throw away level in the search
        if(p != portals.end()) {
            bool outer = c.x == 0 or c.x == width-1 or c.y == 0 or c.y == height-1;
            auto endpoint = p->second;
            c = {endpoint.x,endpoint.y,c.level};
            if(recursive)
                c.level += outer ? -1 : 1;
        }
        return c;
    }

    Tile& get(Coord c) {
        c = actual(c);
        return tiles[c.y*width+c.x];
    }

    const Tile& get(Coord c) const {
        c = actual(c);
        return tiles[c.y*width+c.x];
    }

    const Tile& operator[](Coord c) const {
        return get(c);
    }

    void close(Coord c) {
        auto& t = get(c);
        for_each_neighbor(c,[&](Coord loc) {
            auto& neighbor = get(loc);
            neighbor.for_all_dirs([&](int d, Coord back) {
                if(actual(loc+back) == actual(c)) {
                    neighbor.open_directions.reset(d);
                }
            });
        });
        t.open_directions &= 0;
    }

    template<typename F>
    void for_each_tile(F&& f) const {
        for(int y = 1; y < height-1; ++y) {
            for(int x = 1; x < width-1; ++x) {
                f(Coord{x,y},get(Coord{x,y}));
            }
        }
    }

    template<typename F>
    void for_each_tile(F&& f) {
        for(int y = 1; y < height-1; ++y) {
            for(int x = 1; x < width-1; ++x) {
                f(Coord{x,y},get(Coord{x,y}));
            }
        }
    }

    template<typename F>
    void for_each_neighbor(Coord c, F&& f) const {
        get(c).for_all_dirs([&](int,Coord dir) {
            auto next = actual(c+dir);
            if(next.level < 0 and recursive) return;
            f(actual(c+dir));
        });
    }

    void remove_dead_ends() {
        for_each_tile([this](Coord tc, auto&&) {
            while(get(tc).open_directions.count() == 1 and tc != start and tc != end) {
                Coord next;
                for_each_neighbor(tc,[&](Coord n) {
                    next = n;
                });
                close(tc);
                tc = next;
            }
        });
    }

    void draw() const {
        for(int y = 0; y < height; ++y) {
            for(int x = 0; x < width; ++x) {
                Coord current{x,y};
                if(current == start) {
                    std::cout << 'A';
                } else if(current == end) {
                    std::cout << 'Z';
                } else if(portals.contains(current)) {
                    std::cout << 'P';
                } else if(get(current).open_directions.count() == 0) {
                    std::cout << '#';
                } else {
                    std::cout << '.';
                }
            }
            std::cout << '\n';
        }
    }

    std::vector<Tile> tiles;
    std::map<Coord,Coord> portals;
    std::size_t width, height;
    Coord start, end;
    bool recursive = false;
};

int shortest_path(const Maze& m) {
    std::map<Coord,int> lengths;
    auto cost = [&](Coord c) -> int& {
        auto res = lengths.try_emplace(c,std::numeric_limits<int>::max());
        return res.first->second;
    };
    std::queue<std::pair<Coord,int>> q;
    q.emplace(m.start,0);
    while(not q.empty()) {
        auto [current,len] = q.front();
        q.pop();
        if(len >= cost(current)) continue;
        cost(current) = len;
        if(current == m.end) break;
        m.for_each_neighbor(current,[&q,len=len](Coord c) {
            q.emplace(c,len+1);
        });
    }
    return cost(m.end);
}

std::string_view input = 
R"(                                         J       L   P           P   V T       X                                           
                                         G       V   M           I   O R       C                                           
  #######################################.#######.###.###########.###.#.#######.#########################################  
  #...#.........#.#...#.#...#.........#.....#.#.....#.......#...#...#.....#.#...........#...........#.......#...#.......#  
  ###.#########.#.#.###.#.#######.###.###.###.#####.#.###.###.#####.###.###.#####.#.#######.#####.###.#.#####.#####.#####  
  #.#.....#...........#...#...#.#.#.....#.....#.#...#.#.....#.#.#.....#.....#.....#.#.#.#.......#.#...#.....#.#.#.....#.#  
  #.#####.#####.###.#####.###.#.#######.#.#.###.#.#####.###.#.#.#.#########.#.#.#####.#.###.#######.#.#######.#.###.###.#  
  #...#...#.....#...#.#...#.#.#...#.#.....#.#.......#...#.#.#...#.#.#.......#.#.#...............#.#.#.........#.#.#.....#  
  ###.#.#.#########.#.###.#.#.#.###.#.#.#########.#####.#.#.#.#.#.#.###.#####.###.#.#.#.###.#.###.###.#######.#.#.#.#####  
  #.....#...#.....#.........#...#.#...#.........#.....#.#...#.#.....#.....#.#.#...#.#.#.#...#...........#...#.........#.#  
  #########.#####.#.#.#.#.#.###.#.#######.#####.###.#####.###.###.###.#####.#.#.###.#.#.###.#.#####.#.###.#########.###.#  
  #.#.........#.....#.#.#.#.#.......#.......#.#.#.......#.#...#.#...#...#...#.....#.#.#...#.#.....#.#.............#.#...#  
  #.###.###.#####.#########.###.#####.###.#.#.#####.#####.###.#.###.#.###.###.#.###.#######.###.#.#.#.#######.#####.###.#  
  #...#...#.....#.#.#...#.........#...#...#.#.....#.#.#.....#...#...#.......#.#.#.........#...#.#.#.#.......#.#...#.#.#.#  
  #.#########.###.#.#.#####.#.###.###.#######.###.#.#.#.###.###.###.#.#.#.###.#####.#.###.#.#.###.#.#.#.#######.#.###.#.#  
  #...#.......#.#.#.....#.#.#.#...........#.....#.....#.#...#.....#.#.#.#.#.......#.#.#...#.#.#.#.#.#.#...#...#.#.#.#...#  
  #.#########.#.###.###.#.###########.#########.###########.#.###.###.###.#########.#########.#.#####.#.###.###.###.###.#  
  #...#.#.#.......#.#.....#.....#.....#.#.......#.#...#.#...#...#.#.#.#.#.#...#...........#.#.....#...#.....#...#.......#  
  ###.#.#.#####.#####.###.#####.#####.#.#####.###.###.#.###.#.#####.#.#.###.#######.#######.#.#######.#.###.###.#####.###  
  #.....#.#.#.#.....#.#.#.........#.#.....#.#...........#...#.....#.........#...#...#...#...#.#.#...#.#.#.#...#.#.#.....#  
  #.#.#.#.#.#.#.#######.#########.#.###.###.###.#####.#####.#.#######.#########.###.###.###.###.#.#####.#.#####.#.#.#.###  
  #.#.#.......#.....#.#.#.#.#.#.#.#.....#...#...#.#.#.#...#.#.#.#.#.....#...#...#...#...#.....#.....#.#.#.#...#...#.#.#.#  
  #####.#####.#.#####.#.#.#.#.#.#.###.#####.#.###.#.###.###.#.#.#.#.#.###.###.#.#.#####.#.#.#######.#.###.#.#####.###.#.#  
  #.#.#.#.....#.....#.......................#...#...#.......#.....#.#.#.......#.#.........#...#.#.#.#...#.....#.#.#.....#  
  #.#.#######.#.#######.###.#.#####.#######.#.#####.#.#.###.###.#####.#######.#.###.#######.#.#.#.#.#.#####.###.#.###.###  
  #...#...........#.#.#.#...#.#...#.#...#.#.#.....#...#...#.#...#...........#.#...#.....#.#.#...........#...#...#.#...#.#  
  ###.#.#.###.#.###.#.#.#.#####.#####.###.#.#.#######.#.#.#.#.###########.###.###.#.#.#.#.#.#.#.#.###.#.###.###.#.#.#.#.#  
  #.....#.#.#.#.#.....#.#...#...#.#.#.....#.#.....#...#.#.#.#...#.#.#...#.#...#.#.#.#.#.#.#.#.#.#.#.#.#...#.......#.#...#  
  ###.#.#.#.#.#####.###########.#.#.#.###.#.#.#####.#.#######.###.#.#.#.#.#.#.#.#.#.#####.#.#######.#######.#.###.#.#####  
  #.#.#.#.#...#.#.......#.......#.....#.#.#.#...#.#.#.......#.......#.#...#.#.#.#...#.#...#.#...#...#...#...#.#...#.....#  
  #.#########.#.###.#.#####.#.#.#####.#.#.#.###.#.###.###.#########.#.#######.#.#####.###.###.###.#####.#########.###.###  
  #.....#.#.#.#.....#...#...#.#.#.......#...#.....#.....#...#.......#.....#.................#...#...#.........#.#.#.#...#  
  #.#####.#.#.#######.#######.#########.#########.#########.#.#########.#.#######.#########.#.###.#####.#######.#.#.#.###  
  #.....#.#.#.#...#.#.#.#.#.#...#      F         O         O X         N U       W        #.#.....#.#.#...#.#.#.........#  
  #.#####.#.#.#.###.#.#.#.#.#.###      Z         G         D L         B Y       W        ###.#####.#.###.#.#.###.###.###  
  #...#.#.#.#.#.#...#.......#...#                                                         #.......#.....#...#...#.#.#...#  
  #.###.#.#.#.#.###.#.#.###.#.#.#                                                         #.#.#######.###.#.###.#.#.#.###  
PL....#.#.#...#...#...#...#...#.#                                                         #.#.#.#.#...#.#.#.....#.#.#.#.#  
  #.###.#.###.#.###.#.#.#.###.#.#                                                         #.###.#.#.###.###.#######.#.#.#  
  #.......#.#.......#.#.#.#...#..EL                                                     PM..#.........#.#.....#.#.......#  
  #.#.#.###.###.#.#.###########.#                                                         #.###.###.###.#.#.#.#.###.###.#  
  #.#.#.........#.#.#.....#...#.#                                                         #.#.#...#.......#.#.......#....BR
  #############.#.#####.###.#####                                                         #.#.###.#########.#.#.###.###.#  
YP..#.........#.#...#.#.#.#.....#                                                         #.#...#.....#.#.#.#.#...#...#.#  
  #.#.###.#.#####.###.#.#.###.#.#                                                         #.#.#.###.###.#.###########.#.#  
  #...#.#.#.#.#.#.#...#.....#.#.#                                                         #...#.....#.#.#.#...#.#...#.#.#  
  #.###.###.#.#.###.#.#.#.###.###                                                         ###########.#.#.#.###.###.###.#  
  #...#.#...........#...#........TH                                                       #.......#...............#...#.#  
  ###.#.#####################.###                                                         #.#####.#.###.###.#####.#.#.###  
EV..#.#...#.................#...#                                                       LV..#.#.....#...#...#.#.#...#.#..UN
  #.###.#.#####.#.###.#.#.###.###                                                         #.#.#.###.###.#.#.#.#.#####.#.#  
  #.#...#...#...#.#...#.#.#.#...#                                                         #.#...#.#.#.#.#.#.#.#.......#.#  
  #.#.#####.#.#.#.###.###.#.#####                                                         #######.###.#######.#.#######.#  
  #.#.#.....#.#.#...#.#.#.......#                                                         #.#.......#.....#.#.#.........#  
  #.#.#.#######.#######.###.#.#.#                                                         #.#####.#.###.###.#.###########  
  #...#...........#...#...#.#.#..XC                                                       #...#.#.#.........#...........#  
  #######.#########.###.###.#####                                                         #.#.#.###.###.###.###.#.#.#.###  
WV..#.#.#.#...............#.#.#.#                                                         #.#...#.#.#.#.#.......#.#.#....OD
  #.#.#.#.#.#.#.###.#####.###.#.#                                                         #.###.#.#.#.#########.#########  
  #.....#.#.#.#...#.#.....#.#.#..PI                                                       #.#.....#...#.....#.#.....#...#  
  #####.###.#####.#.#####.#.#.#.#                                                         #.#.#.#.###.###.###.#########.#  
AA........#.....#.#.#...#.......#                                                       UN..#.#.#.....#...#...#.#.#.#...#  
  #.#######.###########.###.###.#                                                         ###.###########.###.#.#.#.###.#  
  #...........#.#.#.#.....#.#.#.#                                                         #...#...#.......#..............OA
  #.#.#.#.#.#.#.#.#.###.#####.###                                                         #####.#.#.#.###.#.#.###.###.#.#  
  #.#.#.#.#.#.....#.............#                                                         #.#...#...#.#.....#.#...#...#.#  
  #################.#########.###                                                         #.#.###.#.#########.###########  
  #.....#.#.#.#.......#.....#...#                                                         #.#...#.#.#.......#.#.#.....#.#  
  #.#.###.#.#.#######.#.###.###.#                                                         #.#.###.#.#.#########.#.#####.#  
  #.#.#...#...#.#...#.....#.#.#.#                                                       SL....#.#.#.#.#.#.....#...#.#...#  
  #.#.#.#.#.###.#.#.#######.#.#.#                                                         #####.#####.#.#.#.#####.#.#.###  
EL..#...#.........#.........#.#..WV                                                       #...............#.#.#..........XP
  #.###########.###.#########.###                                                         #.#########.###.###.###.#####.#  
  #.#.......#...#...#...........#                                                         #.#.....#...#...#...#.......#.#  
  ###.#####.###.#########.#.###.#                                                         #.#.###.#.#.#####.#.#####.#.#.#  
UY..#...#.....#.#.........#.#....XP                                                     PL..#...#...#.#.#.#.#...#...#.#.#  
  #.#.###.#.###########.#.#.#####                                                         #.###.#######.#.###.#.#.#####.#  
  #.#.#...#.#.#.#.#.#...#.#.....#                                                         #...#...............#.....#.#.#  
  #.#.#.#####.#.#.#.###.###.#####                                                         #.#.###############.#.#.###.#.#  
  #...#...................#.....#                                                         #.#.#...........#...#.#.#...#.#  
  ###############.###############                                                         #.#.###.#######.###########.###  
  #...........#.#.#.............#                                                         #.#.#.....#...........#...#.#.#  
  #####.#.#.###.###.#######.###.#                                                         #########.#.#.###########.#.#.#  
  #.....#.#.#.#.#.........#.#...#                                                         #.#.#.....#.#.#...#...#...#....TH
  #.#####.###.#.#######.#####.###                                                         #.#.###.#.#.#########.###.#.#.#  
ZZ....#...#...#.#...........#.#.#                                                       JG........#.#.................#.#  
  ###.#.###.#.#.###.#.#.#####.#.#                                                         #.###.#.###.#.#.#####.###.#.###  
JH....#.....#.......#.#...#......EV                                                       #.#...#...#.#.#...#.....#.#...#  
  #.#.#######.#.#####.#.#####.###                                                         #.###.#########.###.#.#####.#.#  
  #.#.#.......#.#.#.#.#.....#.#.#                                                         #.#...#...........#.#.#.#...#.#  
  #.#.###.#.#.###.#.#.#######.#.#    V     J           Y       T     C     B       O      #.#####.###.#.###.#.###.###.#.#  
  #.#.#...#.#...#.....#.#.......#    O     H           P       R     K     R       A      #.#.....#...#...#.#.#.#.....#.#  
  #.#.#.#.###.#.#.#.#.#.#.###.#.#####.#####.###########.#######.#####.#####.#######.###############.#.#.#.###.#.#.#.#.###  
  #.#.#.#.#...#.#.#.#...#...#.#.#.......#.......#...#.....#.....#.......#...#...#.........#.#.#.....#.#.#.#.#.#...#.#.#.#  
  ###.#####.#.#######.###.###.#######.#####.#####.###.#######.###.#######.###.#.#.#.#.###.#.#.###.#####.###.#########.#.#  
  #.....#.#.#.....#...#...#.#.#...........#.........#.....#...#.#.....#.#.....#.#.#.#.#.....#...#.#.#.........#.........#  
  #.#####.#.###.#####.#####.#.#.###.###.#.###.#.###.#####.#.#.#.#.#####.###.###.#.#####.#.###.#####.###.###.###.#.#.###.#  
  #...#...#...#.#.........#...#.#...#.#.#.#.#.#...#.#.....#.#...#.......#.#.#...#.#...#.#.#.....#.#.....#.....#.#.#.#...#  
  #######.#####.#####.#######.#####.#.#.###.#####.#####.###.###########.#.#####.#.#.#########.###.###.#.###.#######.###.#  
  #.......#.#.....#...#.........#...#.#.#...#.........#...#.#.#.......#...#.#.#.#...#...#...#.#.....#.#.#.#.#.........#.#  
  #.#.#.#.#.#.#####.#####.###.#####.#.#.#.#####.#.#.#.###.#.#.#####.#.#.###.#.#.#.###.###.###.###.###.###.###.#.###.#####  
  #.#.#.#.......#...#...#.#...#.......#.#...#...#.#.#.#.#.#.....#...#.#.....#...#...#.#.#.........#.#...#...#.#.#.......#  
  #######.###.###.#.#.###############.###.#####.###.###.#.#.#.#.#.#.#.#.###.###.###.#.#.#.###.#.###.###.#.#.#.#####.#.#.#  
  #...#.#.#.....#.#.#.#.........#.#.........#.....#.#...#.#.#.#.#.#.#.....#.#...#...#...#...#.#.....#.#.#.#.......#.#.#.#  
  #.###.###.#.#####.#.#########.#.#######.#.###.#####.###.#.#.#####.###.#######.#.###.###.#######.#.#.#####.#.#.#.###.###  
  #.....#...#...#.#.....#...............#.#.#.....#.......#.#.#.....#.#...#.....#.....#.....#.....#.....#.#.#.#.#.#.....#  
  #####.#.#.###.#.#.#########.#####.###.#.###.###.#######.#.#####.###.#.#.#####.#.###.#.#.#######.#.#.###.#.#######.#.#.#  
  #.......#.#.#.#.....#.......#.#...#.#.....#.#...#.#.#...#...#.......#.#.#.....#.#.....#...#...#.#.#.#.......#.#.#.#.#.#  
  #.###.#.#.#.###.#######.#####.#.#.#####.#.###.###.#.#.#.#.#####.#####.#####.###.#.###.###.#.###.#.###########.#.#.#.#.#  
  #.#.#.#.#...#...#...#.#.#.#.#.#.#.....#.#...#...#.....#.#...#.#.....#.#.......#.#.#...#.#.....#.#.#.........#...#.#.#.#  
  #.#.#.#.#.###.#####.#.###.#.#.###.#######.#####.#.###.###.#.#.#.#############.#######.#.#.###.#####.#.###.###.#####.###  
  #.#.#.#.#...#...#.#.....................#.#.....#...#.#...#...#.#...#.#.......#...#.#...#.#.#.#.....#.#.........#.#...#  
  #.#.#.#.#.#######.#####.#####.#####.#########.#.#.#########.#.#.###.#.#####.###.###.#.#.###.#####.#########.#####.#####  
  #.#...#.#.#...#.........#.#.#.#.......#...#.#.#.#.........#.#.#.#.....#...........#...#.#.......#.#.#.#.#...........#.#  
  #.#######.###.###.#######.#.#####.#####.###.#.#######.#####.###.###.#.###.###.#######.#######.###.#.#.#.###.###.###.#.#  
  #.....#.#.#.#.#.#.#.#.....#.........#.........#.#...#...#.#...#.....#.#.#...#.#.#.#.#.....#...............#...#.#.....#  
  #.#####.###.#.#.###.#####.#######.#####.#.###.#.#.#.#.###.#.#########.#.#.###.#.#.#.#.#########.#####.#.#.#######.#.#.#  
  #.#.#.......................#.#.#.#...#.#.#.....#.#...#.#...#.#.#.......#.#.....#.#...#...#.........#.#.#.......#.#.#.#  
  #.#.#.###.#####.#########.#.#.#.#.#.###########.#.###.#.#.###.#.###.###.###.#####.###.###.#.#.#.#.###.#####.#.###.#####  
  #.#...#.#.#.#...#.........#.........#...#.#.....#...#.#.......#...#...#.#.....#...#.........#.#.#...#...#...#.#.#...#.#  
  #######.###.###.#####.#####.#####.#.#.###.###.###.#######.#.#.#.#####.#######.#.#.#.#####.#####.#.#.#.#####.###.#####.#  
  #...............#.....#.......#...#.....#.......#.....#...#.#.#.......#.......#.#.......#.....#.#.#.#.....#...........#  
  #####################################.#####.#######.#######.###.#########.#####.#######################################  
                                       O     C       N       X   F         S     W                                         
                                       G     K       B       L   Z         L     W                                         )";


int main() {
    Maze m(input);
    m.draw();
    std::cout << "Part 1: " << shortest_path(m) << '\n';
    m.recursive = true;
    std::cout << "Part 2: " << shortest_path(m) << '\n';
}
